%% -*-mode: tex-mode -*-

\NeedsTeXFormat{LaTeX2e}%
\ProvidesPackage{chklref}%
\RequirePackage{afterpackage}
%%[2008/04/12\space v2.0]

\xdef\@chk@currentfile{\jobname.tex}
\xdef\old@filename{\jobname.tex}

\def\push#1{\xdef\old@filename{{#1}\old@filename}} 
\def\pop{\expandafter\popit\old@filename\theend}
\def\popit#1#2\theend#3{\def#3{#1}%
  \xdef\old@filename{#2}} 

\newwrite\chk@write
\immediate\openout\chk@write\jobname.tex.chk%
\def\chk@print#1{%
  \begingroup
    \set@display@protect
    \immediate\write\chk@write{#1}%
  \endgroup
}

\long\def \InputIfFileExists#1#2{%
  \IfFileExists{#1}{#2\@addtofilelist{#1}%
    \push{\@chk@currentfile}%
    \xdef\@chk@currentfile{#1}%
    \@@input \@filef@und%
    \pop\@temp%
    \xdef\@chk@currentfile{\@temp}}}

\def\@input#1{%
  \IfFileExists{#1}{%
    \push{\@chk@currentfile}%
    \xdef\@chk@currentfile{#1}%
    \@@input\@filef@und%
    \pop\@temp%
    \xdef\@chk@currentfile{\@temp}}
  {\typeout{No file #1.}}}
  

%% Don't want to redefine \input toto while in preamble because it breaks
%% loading babel.
\AtBeginDocument{%
\def\input{\@ifnextchar\bgroup\@iinput\@@chk@input}
\def\@@chk@input#1 {%
  \push{\@chk@currentfile}%
  \xdef\@chk@currentfile{#1}%
  \@@input #1%
  \pop\@temp%
  \xdef\@chk@currentfile{\@temp}
}}


\let\begin@orig=\begin
\def\begin#1{%
    \chk@print{begin{#1} line \the\inputlineno\space file \@chk@currentfile}%
    \begin@orig{#1}%
}

\let\end@orig=\end
\def\end#1{%
   \chk@print{end{#1} line \the\inputlineno\space file \@chk@currentfile}%
   \end@orig{#1}%
}

\AfterPackage{hyperref}{
  \AtBeginDocument{%
    \let\label@orig=\label
    \def\label#1{%
      \label@orig{#1}%
      \chk@print{label #1 line \the\inputlineno\space file \@chk@currentfile}}

    \Hy@SetCatcodes
    \def\HyPsd@ref#1{\HyPsd@@ref#1*\END}%
    \def\HyPsd@@ref#1*#2\END{%
      \ifx\\#2\\%
        \HyPsd@@@ref{#1}%
      \else
        \expandafter\HyPsd@@@ref
      \fi
    }%
    \def\HyPsd@@@ref#1{%
      \expandafter\ifx\csname r@#1\endcsname\relax
        ??%
      \else
        \expandafter\expandafter\expandafter\@car\csname r@#1\endcsname\@nil
      \fi
      \chk@print{ref #1 line \the\inputlineno\space file \@chk@currentfile}%
    }
    \let\ref=\HyPsd@ref
    \Hy@RestoreCatcodes
  }
}

\AtBeginDocument{%
  \@ifpackageloaded{amsmath}{% With AMS-LaTeX tags
    \let\label@in@display@orig=\label@in@display
    \def\label@in@display#1{%
      \chk@print{label #1 line \the\inputlineno\space file \@chk@currentfile}
      \label@in@display@orig{#1}}
    
    \let\ref@orig=\ref
    \def\ref#1{%
      \ref@orig{#1}%
      \chk@print{ref #1 line \the\inputlineno\space file \@chk@currentfile}}

    \let\eqref@orig=\eqref
    \def\eqref#1{%
      \chk@print{ref #1 line \the\inputlineno\space file \@chk@currentfile}
      \eqref@orig{#1}}

    \let\label@orig=\label
    \def\label#1{%
      \label@orig{#1}%
      \chk@print{label #1 line \the\inputlineno\space file \@chk@currentfile}}
  }}

\AtBeginDocument{%
  \@ifpackageloaded{hyperref}{}{%
    \let\label@orig=\label
    \def\label#1{%
      \label@orig{#1}%
      \chk@print{label #1 line \the\inputlineno\space file \@chk@currentfile}}
    
    \let\ref@orig=\ref
    \def\ref#1{%
      \ref@orig{#1}%
      \chk@print{ref #1 line \the\inputlineno\space file \@chk@currentfile}}
  }
}
\endinput
