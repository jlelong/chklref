%% -*-mode: tex-mode -*-

\NeedsTeXFormat{LaTeX2e}%
\ProvidesPackage{chklref}%
[2008/04/12\space v2.0]

\gdef\currentfile{\jobname.tex}

\newwrite\chk@write
\immediate\openout\chk@write\jobname.tex.chk%
\def\chk@print#1{%
  \immediate\write\chk@write{#1}%
}

\let\include@orig=\include
\def\include#1{\gdef\currentfile{#1.tex}%
  \include@orig{#1}}

\let\input@orig=\input
\def\Input#1{\gdef\currentfile{#1}%
  \input@orig #1}

\let\begin@orig=\begin
\def\begin#1{%
    \chk@print{begin{#1} line \the\inputlineno\space file \currentfile}%
    \begin@orig{#1}%
}

\let\end@orig=\end
\def\end#1{%
   \chk@print{end{#1} line \the\inputlineno\space file \currentfile}%
   \end@orig{#1}%
}


\AtBeginDocument{%
\let\label@orig=\label
\def\label#1{%
  \label@orig{#1}%
  \chk@print{label #1 line \the\inputlineno\space file \currentfile}}

\let\ref@orig=\ref
%% \def\ref#1{%
%%   \ref@orig{#1}%
%%   \chk@print{ref #1 line \the\inputlineno\space file \currentfile}}


\expandafter\DeclareRobustCommand\expandafter
  {\csname relax\string\ref\endcsname}[1]{\ref@orig{#1}%
    \chk@print{ref #1 line \the\inputlineno\space file \currentfile}}%
\expandafter\let\expandafter\ref\csname relax\string\ref\endcsname


\@ifpackageloaded{amsmath}{% With AMS-LaTeX tags
\let\label@in@display@orig=\label@in@display
\def\label@in@display#1{%
  \chk@print{label #1 line \the\inputlineno\space file \currentfile}
  \label@in@display@orig{#1}}

\let\eqref@orig=\eqref
\def\eqref#1{%
  \chk@print{ref #1 line \the\inputlineno\space file \currentfile}
  \eqref@orig{#1}}
  
}%

}
\endinput
