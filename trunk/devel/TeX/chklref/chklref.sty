%% -*-mode: tex-mode -*-

\NeedsTeXFormat{LaTeX2e}%
\ProvidesPackage{chklref}%
\RequirePackage{afterpackage}
[2008/04/12\space v2.0]

\gdef\currentfile{\jobname.tex}

\newwrite\chk@write
\immediate\openout\chk@write\jobname.tex.chk%
\def\chk@print#1{%
  \immediate\write\chk@write{#1}%
}

\let\include@orig=\include
\def\include#1{\gdef\currentfile{#1.tex}%
  \include@orig{#1}}

%%%%%%%%%%%%%%%%%%%
\def\@iinput#1{%
  \typeout{#1}
  \xdef\currentfile{#1}
  \InputIfFileExists{#1}{}%
  {\filename@parse{#1}%
   \edef\reserved@a{\noexpand\@missingfileerror
     {\filename@area\filename@base}%
     {\ifx\filename@ext\relax tex\else\filename@ext\fi}}%
   \reserved@a}}
\def\@input#1{%
  \IfFileExists{#1}{%
    \filename@parse{#1}%
    \xdef\currentfile{\filename@base.tex}%
    \@@input\@filef@und}{\typeout{No file #1.}}}

\def\@input@#1{   \filename@parse{#1}%
  \xdef\currentfile{\filename@base.tex}%
  \InputIfFileExists{#1}{}{\typeout{No file #1.}}}
%%%%%%%%%%%%%%%%%%%% 

\let\begin@orig=\begin
\def\begin#1{%
    \chk@print{begin{#1} line \the\inputlineno\space file \currentfile}%
    \begin@orig{#1}%
}

\let\end@orig=\end
\def\end#1{%
   \chk@print{end{#1} line \the\inputlineno\space file \currentfile}%
   \end@orig{#1}%
}

\AfterPackage{hyperref}{
  \AtBeginDocument{%
    \let\label@orig=\label
    \def\label#1{%
      \label@orig{#1}%
      \chk@print{label #1 line \the\inputlineno\space file \currentfile}}
    
    \let\ref@orig=\ref
    \def\ref#1{%
      \ref@orig{#1}%
      \chk@print{ref #1 line \the\inputlineno\space file \currentfile}}
  }
}

\AtBeginDocument{%
  \@ifpackageloaded{amsmath}{% With AMS-LaTeX tags
    \let\label@in@display@orig=\label@in@display
    \def\label@in@display#1{%
      \chk@print{label #1 line \the\inputlineno\space file \currentfile}
      \label@in@display@orig{#1}}
    
    \let\ref@orig=\ref
    \def\ref#1{%
      \ref@orig{#1}%
      \chk@print{ref #1 line \the\inputlineno\space file \currentfile}}

    \let\eqref@orig=\eqref
    \def\eqref#1{%
      \chk@print{ref #1 line \the\inputlineno\space file \currentfile}
      \eqref@orig{#1}}
  }%
  \@ifpackageloaded{hyperref}{}{%
        \let\label@orig=\label
    \def\label#1{%
      \label@orig{#1}%
      \chk@print{label #1 line \the\inputlineno\space file \currentfile}}
    
    \let\ref@orig=\ref
    \def\ref#1{%
      \ref@orig{#1}%
      \chk@print{ref #1 line \the\inputlineno\space file \currentfile}}
  }
}
\endinput
